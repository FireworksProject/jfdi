#!/bin/bash
# Usage: jfd deploy <package> <domain_name>
# Summary: Deploy the specified package to a remote box.
# Help: The <domain_name> will probably be something like '192.168.1.127',
# 'massive.fwp-dyn.com' or 'massive-b.fwp-dyn.com'.
#
#   Packages:
#     pinfinity_co  - The www.pinfinity.co website.
#     pinfinity_hub - The www.pinfinity.co/hub/ webapp.
#     toehold       - Deploy the toehold scripts to /tmp
#     build         - Deploy the build scripts to /home/build

source "$_JFD_LIB/utils.sh"

main () {
	local package="$1"
	local domain_name="$2"

	if [ -z $package ]; then
		fail "The <package> argument is required."
	fi

	if [ -z $domain_name ]; then
		fail "The <domain_name> argument is required."
	fi

	case "$package" in
	"toehold" )
	    remote_sync "$_JFD_ROOT" "vagrant@$domain_name:/tmp/"
		;;
	"build" )
	    remote_sync "$_JFD_ROOT" "vagrant@$domain_name:/home/vagrant/"
        remote_sync "$_REPO_ROOT/chef/" "vagrant@$domain_name:/home/vagrant/build/"
        remote_sync "$_REPO_ROOT/cookbooks" "vagrant@$domain_name:/home/vagrant/build/"
		;;
	"pinfinity_co" )
        deploy_pinfinity_co $domain_name
		;;
	"pinfinity_hub" )
        deploy_pinfinity_hub $domain_name
		;;
	* )
		echo "Invalid package '$package'. No action taken."
		exit 0
		;;
	esac

}

deploy_pinfinity_co () {
    local domain_name=$1
    local src="$_REPO_ROOT/webapps/pinfinity_co"
    local dest="vagrant@$domain_name:/webapps/pinfinity_co"

    if ! [ -d "$src" ]; then
        echo "The src directory ($src) is not linked."
        exit 1
    fi

    echo "From: $src"
    echo "To: $dest"
    remote_sync "$src/" "$dest/"
}

deploy_pinfinity_hub () {
    local domain_name=$1
    local src="$_REPO_ROOT/webapps/pinfinity_hub"
    local dest="vagrant@$domain_name:/webapps/pinfinity_hub"

    if ! [ -d "$src" ]; then
        echo "The src directory ($src) is not linked."
        exit 1
    fi

    echo "From: $src"
    echo "To: $dest"
    remote_sync "$src/" "$dest/"

    echo ""
    echo "Remember to log in to the server and restart pinfinity_hub."
}

main $@
